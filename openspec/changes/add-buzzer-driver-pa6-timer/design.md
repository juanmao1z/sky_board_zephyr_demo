## Context

当前工程已有 Zephyr 平台抽象层与 DTS 配置，且已使用 PWM（背光）。本次需求确认为固定有源蜂鸣器模式，连接 PA6，且不读取拨码开关。设计目标是提供独立平台驱动能力，接口支持外部传入 `freq/duty` 并自动裁剪到安全范围。

## Goals / Non-Goals

**Goals:**

- 基于 Zephyr PWM 驱动实现固定有源蜂鸣器控制，输出固定为 PA6 对应定时器通道。
- 提供平台层蜂鸣器接口（初始化、开、关），并开放 `freq/duty` 参数。
- `freq/duty` 越界自动裁剪，避免调用方传参异常导致不可用。
- 异常路径保持蜂鸣器关闭，并输出可诊断日志。

**Non-Goals:**

- 不实现拨码读取和有源/无源动态切换逻辑。
- 不接入 `ButtonService` 或其他业务触发策略。
- 不实现旋律编排、序列播放或音效模板。

## Decisions

### 1) 使用 Zephyr PWM API 作为驱动接口

- 决策: 使用 `pwm_dt_spec` + `pwm_set_dt` 实现蜂鸣器控制，并根据 `freq_hz` 动态换算 period。
- 原因: 保持与现有平台代码一致，同时满足外部参数接口要求。
- 备选:
  - 直接使用 STM32 HAL TIM: 灵活但破坏统一抽象，维护成本更高。

### 2) 板级使用 PA6 对应定时器通道作为蜂鸣器输出

- 决策: 在板级 DTS/overlay 为 PA6 配置对应 TIM 通道，并建立蜂鸣器节点与 alias。
- 原因: 满足硬件连接约束（PA6），并保持设备树可配置性。
- 备选:
  - 运行时硬编码 GPIO+软 PWM: 抖动大且占用 CPU，不利于稳定输出。

### 3) 新增平台蜂鸣器抽象

- 决策: 在 `include/platform/` 定义 `buzzer_init/buzzer_on/buzzer_off`，其中 `buzzer_on(freq_hz, duty_percent)` 支持外部参数。
- 原因: 与 `platform_display/platform_ws2812` 等现有模式一致，上层调用简单。
- 备选:
  - 直接在应用层操作 PWM: 会让硬件细节泄漏到业务层，不利于复用。

### 4) 参数越界采用自动裁剪

- 决策: 在驱动内部对 `freq_hz` 与 `duty_percent` 做 min/max 裁剪，不向调用方返回参数越界错误。
- 原因: 调用方体验更稳定，避免因边界输入导致蜂鸣器完全不可用。
- 备选:
  - 参数越界直接报错: 行为更严格，但对上层约束更强且不符合已确认策略。

## Risks / Trade-offs

- [PA6 复用冲突] 与其他外设功能冲突导致蜂鸣器不可用 -> 在 DTS 中集中声明并在初始化时检查 `device_is_ready`。
- [输入参数异常] 调用方给出极端 `freq/duty` 可能导致不可听或异常输出 -> 在驱动层裁剪并记录调试日志。
- [驱动初始化失败] 设备未就绪导致无法控制输出 -> 返回错误码并在失败路径保持关闭。
- [活跃电平不匹配] 有源蜂鸣器可能与默认极性不一致 -> 在 DTS 中通过 `pwms` 极性参数调整。

## Migration Plan

1. 更新板级 DTS/overlay，增加 PA6 定时器 PWM 节点与蜂鸣器 alias。
2. 新增平台蜂鸣器头文件与 Zephyr 实现文件，完成 `init/on(freq,duty)/off` 接口。
3. 在驱动层增加 `freq/duty` 参数裁剪逻辑与日志。
4. 增加最小验证路径（编译 + 实机蜂鸣器开关验证）。
5. 若上线后发现异常，回滚到不启用蜂鸣器节点与调用路径即可恢复原行为。

## Open Questions

- 无。
