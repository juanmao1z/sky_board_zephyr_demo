# lckfb_sky_board_stm32f407 显示接入方案（ST7789V2）

## 目标

在 `lckfb_sky_board_stm32f407.dts` 中接入 ST7789V2 显示，使用 SPI1 + MIPI-DBI，背光 PB8 使用 TIM10_CH1 PWM（低电平有效，使用反相极性），并保留三按键。

## 已确定

1. 屏幕按 240x320 竖屏先落地（x/y offset=0）。
2. FT6336 本次先不接入。
3. AP3216C 本次先不接入（当前仓库无现成 binding/driver）。
4. PB8 改为背光专用，不再作为 led1（走 PWM 调光）。
5. KEY1/KEY2/KEY3 全部高电平有效。
6. 触控走软件 I2C（SCL=PD10, SDA=PE13），中断脚 PE2。

## DTS 变更点

1. 顶部新增：
   - `#include <zephyr/dt-bindings/mipi_dbi/mipi_dbi.h>`
2. `/chosen` 新增：
   - `zephyr,display = &st7789v_lcd;`
3. 新增 `mipi_dbi` 节点：
   - `compatible = "zephyr,mipi-dbi-spi"`
   - `spi-dev = <&spi1>`
   - `dc-gpios = <&gpiod 14 GPIO_ACTIVE_HIGH>`
   - `reset-gpios = <&gpioe 1 GPIO_ACTIVE_LOW>`
   - `write-only`
4. `mipi_dbi` 下新增 `st7789v_lcd: st7789v@0`：
   - `compatible = "sitronix,st7789v"`
   - `mipi-mode = "MIPI_DBI_MODE_SPI_4WIRE"`
   - `mipi-max-frequency = <20000000>`
   - `width = <240>`, `height = <320>`
   - `x-offset = <0>`, `y-offset = <0>`
   - 初始化参数使用 ST7789 参考值（vcom/gctrl/vrhs/vdvs/mdac/colmod/gamma 等）
5. `&spi1`：
   - `status = "okay"`
   - `pinctrl-0 = <&spi1_sck_pa5 &spi1_mosi_pb5>`
   - `cs-gpios = <&gpioe 14 GPIO_ACTIVE_LOW>`
6. 背光：
   - 顶部新增 `#include <zephyr/dt-bindings/pwm/pwm.h>`
   - 新增 `lcd_backlight`（`compatible = "pwm-leds"`）以及子节点 `backlight_pwm`
   - `pwms = <&pwm10 1 PWM_USEC(100) PWM_POLARITY_INVERTED>`，适配板上背光低电平点亮
   - `&timers10` 下启用 `pwm10` 子节点并复用 `tim10_ch1_pb8`
   - aliases 增加 `pwm-led0 = &backlight_pwm`
7. 按键：
   - `KEY1=PA0`、`KEY2=PE8`、`KEY3=PC13`，全部 `GPIO_ACTIVE_HIGH`
   - aliases 增加 `sw0/sw1/sw2`
8. 触控（软件 I2C）：
   - 新增 `touch_i2c` 节点，`compatible = "gpio-i2c"`
   - `scl-gpios = <&gpiod 10 (GPIO_OPEN_DRAIN | GPIO_PULL_UP)>`
   - `sda-gpios = <&gpioe 13 (GPIO_OPEN_DRAIN | GPIO_PULL_UP)>`
   - 挂载 `touch@38`（`compatible = "focaltech,ft5336"`，用于 FT6336 兼容路径）
   - 中断脚：`int-gpios = <&gpioe 2 GPIO_ACTIVE_LOW>`

## 验证

1. `west build` 通过，无 devicetree 错误。
2. `build/zephyr/zephyr.dts` 可见 `zephyr,display` 指向 `st7789v_lcd`。
3. display sample 能点亮并刷新。
4. 背光可由 PWM 占空比调节（应用层通过 LED/PWM API 控制）。
5. 触控需要应用启用输入与软件 I2C：
   - `CONFIG_INPUT=y`
   - `CONFIG_I2C_GPIO=y`
   - `CONFIG_INPUT_FT5336=y`
