# 传感器接入指南（基于 SensorHub 泛化框架）

## 1. 目的

本指南用于在当前项目中新增传感器（例如 BH1750、SHT4x），并接入统一的 `SensorHub + SensorService` 框架。

## 2. 当前框架结构

- 抽象与类型：`include/platform/platform_sensors.hpp`
- Zephyr 适配实现：`subsys/platform/zephyr_sensors.cpp`
- 后台采样服务：`include/servers/sensor_service.hpp` + `subsys/servers/sensor_service.cpp`
- 启动链路：`app/app_Init.cpp`

核心思想：

- 每个具体传感器实现 `ISensorDriver`
- 在 `sensor_hub()` 中注册驱动
- `SensorService` 按注册表自动遍历采样，不需要为每个新传感器单独写线程逻辑

## 3. 新增一个传感器的标准步骤

1. 在 `platform_sensors.hpp` 扩展 `SensorType` 与样本结构体。
1. 在板级 DTS 增加传感器节点（地址、总线、兼容串）。
1. 在 `prj.conf` 打开对应 Zephyr 驱动 Kconfig。
1. 在 `zephyr_sensors.cpp` 新增驱动类（继承 `ISensorDriver`）。
1. 在 `sensor_hub()` 中注册新驱动。
1. （可选）在 `SensorService::maybe_log_snapshot()` 增加该类型的人类可读日志格式。
1. 编译验证并串口确认。

## 4. 第 1 步：扩展公共类型

文件：`include/platform/platform_sensors.hpp`

新增内容示例（以 BH1750 为例）：

```cpp
enum class SensorType : uint8_t {
    Ina226 = 0,
    Aht20 = 1,
    Bh1750 = 2,
};

struct Bh1750Sample {
    int32_t lux_milli = 0;
    int64_t ts_ms = 0;
};
```

说明：

- `SensorType` 作为 Hub 路由键，必须唯一。
- 建议统一使用整数单位，避免浮点。

## 5. 第 2 步：新增 DTS 节点

按你的板级实际文件修改（当前常用路径）：

- `boards/st/lckfb_sky_board_stm32f407/lckfb_sky_board_stm32f407.dts`

示例（挂在 `&i2c1` 下）：

```dts
bh1750_sensor: bh1750@23 {
    compatible = "rohm,bh1750";
    reg = <0x23>;
    status = "okay";
};
```

注意：

- 地址不要与现有设备冲突。
- 若换 I2C 控制器，需要同步 pinctrl 与时钟配置。

## 6. 第 3 步：打开 Kconfig

文件：`prj.conf`

示例：

```conf
CONFIG_SENSOR=y
CONFIG_BH1750=y
```

若驱动名不确定，请先在 Zephyr 源码中确认对应 Kconfig 符号。

## 7. 第 4 步：实现驱动类

文件：`subsys/platform/zephyr_sensors.cpp`

模板：

```cpp
class ZephyrBh1750Sensor final : public platform::ISensorDriver {
public:
    platform::SensorType type() const noexcept override { return platform::SensorType::Bh1750; }

    int init() noexcept override {
        if (ready_) { return 0; }
        if (dev_ == nullptr || !device_is_ready(dev_)) { return -ENODEV; }
        ready_ = true;
        return 0;
    }

    size_t sample_size() const noexcept override { return sizeof(platform::Bh1750Sample); }

    int read(void *out, size_t out_size) noexcept override {
        if (out == nullptr) { return -EINVAL; }
        if (out_size < sizeof(platform::Bh1750Sample)) { return -ENOSPC; }
        auto &sample = *static_cast<platform::Bh1750Sample *>(out);

        int ret = init();
        if (ret < 0) { return ret; }
        ret = sensor_sample_fetch(dev_);
        if (ret < 0) { return ret; }

        struct sensor_value light = {};
        ret = sensor_channel_get(dev_, SENSOR_CHAN_LIGHT, &light);
        if (ret < 0) { return ret; }

        sample.lux_milli = static_cast<int32_t>((static_cast<int64_t>(light.val1) * 1000LL) + (light.val2 / 1000));
        sample.ts_ms = k_uptime_get();
        return 0;
    }

private:
#if DT_NODE_HAS_STATUS(DT_NODELABEL(bh1750_sensor), okay)
    const struct device *dev_ = DEVICE_DT_GET(DT_NODELABEL(bh1750_sensor));
#else
    const struct device *dev_ = nullptr;
#endif
    bool ready_ = false;
};
```

## 8. 第 5 步：注册到 SensorHub

文件：`subsys/platform/zephyr_sensors.cpp`

在静态对象区添加：

```cpp
ZephyrBh1750Sensor g_bh1750_sensor;
```

在 `sensor_hub()` 内添加：

```cpp
const int bh_ret = hub.register_driver(g_bh1750_sensor);
if (bh_ret < 0 && bh_ret != -EALREADY) {
    /* ignore */
}
```

## 9. 第 6 步：服务层读取与日志

`SensorService` 已泛化遍历注册表，通常无需改采样主循环。

如果要可读日志，在 `subsys/servers/sensor_service.cpp` 的 `maybe_log_snapshot()` 增加该类型分支：

```cpp
case platform::SensorType::Bh1750: {
    const auto &s = *reinterpret_cast<const platform::Bh1750Sample *>(sample);
    /* 输出日志 */
    break;
}
```

## 10. 验证清单

1. 构建：

```powershell
d:\zephyrproject\.venv\Scripts\west.exe build -b lckfb_sky_board_stm32f407 myproject/sky_board_zephyr_demo -p auto
```

1. 烧录：

```powershell
d:\zephyrproject\.venv\Scripts\west.exe flash -d d:/zephyrproject/build
```

1. 串口检查：

- `sensor service starting`
- 新传感器对应日志出现
- 其他服务（TCP/Time/SD）无回归

## 11. 常见问题

- `-ENODEV`：DTS 节点未启用、I2C 引脚或地址错误、设备未接好。
- `-ENOENT`：驱动未注册到 `SensorHub` 或 `SensorType` 未匹配。
- `-ENOSPC`：样本结构超过 `SensorService::kMaxSampleBytes`，需要增大缓存槽位大小。
- clangd 报 devicetree 宏误报：先确认 `west build` 结果，以构建结果为准。
