# INA226(0x40) + AHT20-F(0x38) 驱动框架设计

## 1. 目标
- 在 `lckfb_sky_board_stm32f407` 上启用两路 I2C 传感器：
  - `INA226`，地址 `0x40`
  - `AHT20-F`，地址 `0x38`
- 使用 Zephyr 原生传感器驱动，不自写寄存器驱动。
- 提供工程内统一框架：
  - 平台层封装单次读取
  - 服务层后台采样+缓存
  - 应用启动时统一拉起

## 2. 关键决策
- 传感器总线：`I2C1 PB6/PB7`（避免与触摸 `touch_i2c` 的 `0x38` 冲突）。
- 采样模式：后台周期采样并缓存最后有效值。
- 数据输出：先做日志输出与应用内接口，不做网络发布。
- INA226 标定：
  - `rshunt-micro-ohms = 15000`
  - `current-lsb-microamps = 1000`

## 3. 架构
- 驱动层（Zephyr）：
  - DTS 声明 `ina226@40` 与 `aht20@38`
  - Kconfig 打开 `CONFIG_SENSOR/CONFIG_INA226/CONFIG_DHT20`
- 平台层（platform）：
  - `platform_sensors.hpp/.cpp`
  - 提供初始化和单次读取接口，统一单位换算
- 服务层（servers）：
  - `SensorService`
  - 线程周期采样、缓存、周期日志、线程安全读取

## 4. 数据接口
- INA226 样本：
  - `bus_mv`（mV）
  - `current_ma`（mA）
  - `power_mw`（mW）
  - `ts_ms`（uptime ms）
- AHT20 样本：
  - `temp_mc`（milli-Celsius）
  - `rh_mpermille`（千分比湿度，0..1000）
  - `ts_ms`（uptime ms）

## 5. 失败策略
- `sensors_init()` 失败：`SensorService::run()` 直接失败返回，不影响其它服务实现逻辑。
- 运行时单次采样失败：记录日志，保留历史缓存，不崩溃。
- 数据读取接口在无有效缓存时返回 `-EAGAIN`。

## 6. 验证
- 构建验证：
  - `west build -b lckfb_sky_board_stm32f407 myproject/sky_board_zephyr_demo -p auto`
- 启动验证：
  - 出现 `sensor service starting`
  - 周期输出 INA226 与 AHT20 采样日志
- 回归验证：
  - TCP(8000)、TimeService、SdcardService 不回退
